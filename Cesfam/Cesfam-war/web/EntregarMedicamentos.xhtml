<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>Entregar Medicamentos</title>
        <f:event type="preRenderView" listener="#{usuarioBean.verificarSesion()}"/>

    </h:head>
    <h:body onload="#{partidaBean.partida()}" style="background-image: url('../resources/images/fondo-01.jpg');">


        <ui:include src="includes/menu.xhtml"/> <!-- Para incluir el menu -->
        <center>
            <h:form id="form">

                <p:messages id="mensaje" showDetail="false" autoUpdate="false"/>
                <p:panel id="Registrar" header="Entregar Medicamentos" style="margin-top: 20px ;height:700px; width: 900px;">

                    <br/><br/>

                    <h:panelGrid id="entregarMedicamentoPanel" columns="3" cellpadding="5">                       

                        <h:outputText value="Rut del Paciente" />
                        <p:inputText value="#{recetaBean.paciente.rut}" required="true" onkeypress="return justNumbers(event);" requiredMessage="Debe ingresar un rut para verificar" maxlength="9"/>
                        <p:commandButton value="Verificar" type="button" onclick="#{recetaBean.verificarRut()}" icon="ui-icon-help" />
                    
                    </h:panelGrid>           
                    
                    <p:fieldset id="medicamentosDisponiblesField" legend="Medicamentos">
                        <p:dataTable id="medicamentosDisponibles" var="m" value="#{recetaBean.medicamentosBd}" paginator="true" rows="10" emptyMessage="No se han encontrado medicamentos">
                            <p:column style="width:20px">
                                <h:outputText id="dragIcon" styleClass="ui-icon ui-icon-arrow-4" />
                                <p:draggable for="dragIcon" revert="true" helper="clone"/>
                            </p:column>

                            <p:column headerText="Nombre Genérico">
                                <h:outputText value="#{m.nomGenerico}" />
                            </p:column>
                        </p:dataTable>
                    </p:fieldset>

                    <p:fieldset id="medSeleccionadosField" legend="Medicamentos Seleccionados" style="margin-top:20px">
                        <p:outputPanel id="dropArea">
                            <h:outputText value="!!!Suelte aquí los medicamentos!!!" rendered="#{empty recetaBean.seleccionados}" style="font-size:24px;" />
                            <p:dataTable id="MedSeleccionadosTable" var="rm" value="#{recetaBean.seleccionados}" editable="true" editMode="cell" widgetVar="cellMp" rendered="#{not empty recetaBean.seleccionados}">

                                <p:ajax event="cellEdit" />

                                <p:column headerText="Nombre Comercial">
                                    <h:outputText value="#{rm.medicamento.nomComercial}" />
                                </p:column>
                                <p:column headerText="Nombre Genérico">
                                    <h:outputText value="#{rm.medicamento.nomGenerico}" />
                                </p:column>
                                <p:column headerText="Cantidad">
                                    <p:cellEditor>
                                        <f:facet name="output"><h:outputText value="#{rm.cantidad}" /></f:facet>
                                        <f:facet name="input"><p:inputText value="#{rm.cantidad}" style="width:96%" label="Cantidad" onkeypress="return justNumbers(event);"/></f:facet>
                                    </p:cellEditor>
                                </p:column>
                            </p:dataTable>
                        </p:outputPanel>
                    </p:fieldset>

                    
                    <p:droppable for="medSeleccionadosField" tolerance="touch" activeStyleClass="ui-state-highlight" datasource="medicamentosDisponibles" onDrop="handleDrop" >
                        <p:ajax listener="#{recetaBean.onDrop}" update="dropArea medicamentosDisponibles" />
                    </p:droppable>

                    <br/><br/><br/>
                    <p:commandButton value="Entregar Medicamento" update="mensaje" action="#{recetaBean.entregarMedicamentos()}" ajax="false"/>

                                      
                </p:panel>

            </h:form>
        </center>

        <script type="text/javascript">
            function justNumbers(e)
            {
                var keynum = window.event ? window.event.keyCode : e.which;
                if (keynum == 8)
                    return true;

                return /\d/.test(String.fromCharCode(keynum));
            }

            function letras(e)
            {
                var tecla = window.event ? window.event.keyCode : e.which;
                if (tecla == 8)
                    return true;

                patron = /[A-Za-z\s]/; // 4
                te = String.fromCharCode(tecla); // 5
                return patron.test(te);

            }

        </script>

        <script type="text/javascript">
            function handleDrop(event, ui) {
                var droppedCar = ui.draggable;

                droppedCar.fadeOut('fast');
            }
        </script>

        <h:outputScript name="js/spanishLocale.js" />

    </h:body>

</html>
